// LIS Example: Fusão Multimodal
// Demonstra: fuse_vision_audio, state_xor for combining modalities
// Documentação: Seção 8.9

// =========================================
// Fusão Manual (Alternativa)
// =========================================

fn manual_fuse(a: State, b: State) -> State {
    // Combinar via XOR (uma abordagem)
    let combined = state_xor(a, b);

    // Normalizar resultado
    return state_normalize(combined);
}

// =========================================
// Fusão Ponderada
// =========================================

fn weighted_fuse(a: State, b: State, weight_a: Int, weight_b: Int) -> State {
    // Escalar cada estado pelo peso
    let scaled_a = transform_magnitude_scale(a, weight_a);
    let scaled_b = transform_magnitude_scale(b, weight_b);

    // Combinar
    return state_xor(scaled_a, scaled_b);
}

// =========================================
// Fusão por Camadas (Layer-wise)
// =========================================

fn layerwise_fuse(a: State, b: State) -> State {
    let result = state_vacuum();
    let idx = 0;

    loop {
        if idx >= 16 {
            break;
        }

        let layer_a = state_get_layer(a, idx);
        let layer_b = state_get_layer(b, idx);

        // Interpolar cada camada
        let fused_layer = complex_lerp(layer_a, layer_b, 0.5);
        let result = state_set_layer(result, idx, fused_layer);

        let idx = idx + 1;
    }

    return result;
}

// =========================================
// Fusão Hierárquica
// =========================================

// Primeiro fundir pares, depois fundir os resultados
fn hierarchical_fuse(a: State, b: State, c: State, d: State) -> State {
    // Extrair camadas L0 de cada estado para fusão
    let layer_a = state_get_layer(a, 0);
    let layer_b = state_get_layer(b, 0);
    let layer_c = state_get_layer(c, 0);
    let layer_d = state_get_layer(d, 0);

    // Fundir pares
    let fused_ab = fuse_vision_audio(layer_a, layer_b);
    let fused_cd = fuse_vision_audio(layer_c, layer_d);

    // Fundir os resultados
    let final_fused = fuse_vision_audio(fused_ab, fused_cd);

    // Criar estado com resultado na camada L0
    let result = state_vacuum();
    return state_set_layer(result, 0, final_fused);
}

// =========================================
// Verificação de Qualidade da Fusão
// =========================================

fn total_magnitude(s: State) -> Float {
    let total = 0.0;
    let idx = 0;
    loop {
        if idx >= 16 {
            break;
        }
        let total = total + bytesil_magnitude(state_get_layer(s, idx));
        let idx = idx + 1;
    }
    return total;
}

fn main() {
    print_string("=== Multimodal Fusion ===");

    // =========================================
    // Conceito de Fusão Multimodal
    // =========================================
    // Em sistemas inteligentes, diferentes modalidades
    // (visão, áudio, texto, sensores) precisam ser
    // combinadas em uma representação unificada.
    //
    // LIS usa State para representar dados multimodais:
    // - Diferentes camadas podem representar diferentes modalidades
    // - Fusão combina informação de múltiplos estados

    // =========================================
    // Criar Estados de Modalidades
    // =========================================

    // Estado de Visão (exemplo: features de imagem)
    let vision = state_vacuum();
    let vision = state_set_layer(vision, 0, bytesil_new(10, 0));  // Feature 1
    let vision = state_set_layer(vision, 1, bytesil_new(8, 2));   // Feature 2
    let vision = state_set_layer(vision, 2, bytesil_new(12, 4));  // Feature 3
    let vision = state_set_layer(vision, 3, bytesil_new(6, 6));   // Feature 4

    // Estado de Áudio (exemplo: features de áudio)
    let audio = state_vacuum();
    let audio = state_set_layer(audio, 0, bytesil_new(7, 1));   // Feature 1
    let audio = state_set_layer(audio, 1, bytesil_new(9, 3));   // Feature 2
    let audio = state_set_layer(audio, 2, bytesil_new(5, 5));   // Feature 3
    let audio = state_set_layer(audio, 3, bytesil_new(11, 7));  // Feature 4

    print_string("Created vision and audio states");

    // =========================================
    // Fusão Visão + Áudio (fuse_vision_audio)
    // =========================================
    print_string("--- fuse_vision_audio ---");

    // Extrair ByteSil de cada camada para fusão
    let vision_l0 = state_get_layer(vision, 0);
    let audio_l0 = state_get_layer(audio, 0);
    let fused_bs = fuse_vision_audio(vision_l0, audio_l0);

    // Criar estado com o resultado fusionado
    let fused_va = state_vacuum();
    let fused_va = state_set_layer(fused_va, 0, fused_bs);

    print_string("Fused vision+audio state:");
    print_string("Layer 0 magnitude:");
    print_float(bytesil_magnitude(state_get_layer(fused_va, 0)));

    // =========================================
    // Fusão de 3 Modalidades (via state_xor)
    // =========================================
    print_string("--- 3-modality fusion (via state_xor) ---");

    // Estado de Texto (exemplo: embeddings)
    let text = state_vacuum();
    let text = state_set_layer(text, 0, bytesil_new(8, 0));
    let text = state_set_layer(text, 1, bytesil_new(10, 4));
    let text = state_set_layer(text, 2, bytesil_new(6, 8));
    let text = state_set_layer(text, 3, bytesil_new(12, 12));

    // Combine three modalities using state_xor
    let fused_va_text = state_xor(fused_va, text);
    let fused_3 = state_normalize(fused_va_text);

    print_string("Fused 3-modality state:");
    print_string("Layer 0 magnitude:");
    print_float(bytesil_magnitude(state_get_layer(fused_3, 0)));

    // =========================================
    // Fusão Manual (Alternativa)
    // =========================================
    print_string("--- Manual Fusion ---");

    let manual_result = manual_fuse(vision, audio);
    print_string("Manual fusion result layer 0:");
    print_float(bytesil_magnitude(state_get_layer(manual_result, 0)));

    // =========================================
    // Fusão Ponderada
    // =========================================
    print_string("--- Weighted Fusion ---");

    // Dar mais peso à visão (7) que ao áudio (3)
    let weighted = weighted_fuse(vision, audio, 7, 3);

    print_string("Weighted fusion (7 vision, 3 audio):");
    print_string("Layer 0 magnitude:");
    print_float(bytesil_magnitude(state_get_layer(weighted, 0)));

    // =========================================
    // Fusão por Camadas (Layer-wise)
    // =========================================
    print_string("--- Layer-wise Fusion ---");

    let layerwise = layerwise_fuse(vision, audio);
    print_string("Layer-wise fusion result:");
    print_string("Layer 0 magnitude:");
    print_float(bytesil_magnitude(state_get_layer(layerwise, 0)));

    // =========================================
    // Fusão Hierárquica
    // =========================================
    print_string("--- Hierarchical Fusion ---");

    let sensor1 = state_neutral();
    let sensor2 = state_neutral();

    let hierarchical = hierarchical_fuse(vision, audio, sensor1, sensor2);
    print_string("Hierarchical 4-way fusion complete");

    // =========================================
    // Verificação de Qualidade da Fusão
    // =========================================
    print_string("--- Fusion Quality Check ---");

    // Comparar magnitude total antes e depois da fusão
    let vision_mag = total_magnitude(vision);
    let audio_mag = total_magnitude(audio);
    let fused_mag = total_magnitude(fused_va);

    print_string("Vision total magnitude:");
    print_float(vision_mag);
    print_string("Audio total magnitude:");
    print_float(audio_mag);
    print_string("Fused total magnitude:");
    print_float(fused_mag);
}
