name: Release to AUR (ecosystem)

on:
  push:
    tags:
      - 'ecosystem-v*'

jobs:
  aur-publish:
    name: Publish AUR packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pkg:
          - lis-cli
          - lis-format
          - lis-runtime
          - lis-api
          - sil-ecosystem
          - sil-ecosystem-git
          - lis-cli-git
          - lis-format-git
          - lis-runtime-git
          - lis-api-git
    container:
      image: archlinux:latest
    steps:
      - name: Install tooling
        run: |
          pacman -Syu --noconfirm git base-devel openssh

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Derive version from tag
        id: meta
        shell: bash
        run: |
          tag="${GITHUB_REF_NAME}"
          ver="${tag#ecosystem-v}"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Prepare package directory
        working-directory: packaging/aur/${{ matrix.pkg }}
        run: |
          if [[ -f PKGBUILD ]]; then
            if grep -q "@PKGVER@" PKGBUILD; then
              sed -i "s/@PKGVER@/${{ steps.meta.outputs.version }}/g" PKGBUILD
            fi
          fi

      - name: Lock checksum for release tarball (non -git, with source)
        if: ${{ !endsWith(matrix.pkg, '-git') && matrix.pkg != 'sil-ecosystem' }}
        working-directory: packaging/aur/${{ matrix.pkg }}
        shell: bash
        run: |
          # Compute sha256 of the GitHub release tarball
          tar_url="https://github.com/silvanoneto/SIL/archive/refs/tags/ecosystem-v${{ steps.meta.outputs.version }}.tar.gz"
          sum=$(curl -L "$tar_url" | sha256sum | awk '{print $1}')
          # Replace SKIP with the actual checksum in PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${sum}')/" PKGBUILD

      - name: Generate .SRCINFO
        working-directory: packaging/aur/${{ matrix.pkg }}
        run: |
          makepkg --printsrcinfo > .SRCINFO

      - name: Setup AUR SSH
        if: secrets.AUR_SSH_PRIVATE_KEY != ''
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 aur.archlinux.org >> ~/.ssh/known_hosts

      - name: Push to AUR
        if: secrets.AUR_SSH_PRIVATE_KEY != ''
        working-directory: packaging/aur/${{ matrix.pkg }}
        env:
          PKG: ${{ matrix.pkg }}
          VERSION: ${{ steps.meta.outputs.version }}
        run: |
          workdir=$(mktemp -d)
          git -C "$workdir" init
          git -C "$workdir" config user.name "github-actions"
          git -C "$workdir" config user.email "actions@github.com"
          cp PKGBUILD .SRCINFO "$workdir"/
          git -C "$workdir" add PKGBUILD .SRCINFO
          git -C "$workdir" commit -m "release: $PKG $VERSION"
          git -C "$workdir" remote add aur "ssh://aur@aur.archlinux.org/$PKG.git"
          git -C "$workdir" push --force aur HEAD:master

      - name: Upload PKGBUILD artifact (for review)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.pkg }}-PKGBUILD-${{ steps.meta.outputs.version }}
          path: |
            packaging/aur/${{ matrix.pkg }}/PKGBUILD
            packaging/aur/${{ matrix.pkg }}/.SRCINFO
