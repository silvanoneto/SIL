// Paebiru ML Library - Activation Functions

fn from_mag(mag: Float) -> ByteSil {
    return bytesil_from_complex(mag, 0.0);
}

fn relu(x: ByteSil) -> ByteSil {
    let mag = bytesil_magnitude(x);
    if mag > 0.0 {
        return x;
    }
    return bytesil_null();
}

fn sigmoid(x: ByteSil) -> ByteSil {
    let mag = bytesil_magnitude(x);
    let sig = 1.0 / (1.0 + exp(0.0 - mag));
    return from_mag(sig);
}

fn tanh_act(x: ByteSil) -> ByteSil {
    let mag = bytesil_magnitude(x);
    let ep = exp(mag);
    let en = exp(0.0 - mag);
    let th = (ep - en) / (ep + en);
    return from_mag(th);
}

fn gelu(x: ByteSil) -> ByteSil {
    let mag = bytesil_magnitude(x);
    let sqrt_2_pi = sqrt(2.0 / pi());
    let inner = sqrt_2_pi * (mag + 0.044715 * mag * mag * mag);
    let ep = exp(inner);
    let en = exp(0.0 - inner);
    let th = (ep - en) / (ep + en);
    let result = 0.5 * mag * (1.0 + th);
    return from_mag(result);
}

fn swish(x: ByteSil) -> ByteSil {
    let mag = bytesil_magnitude(x);
    let sig = 1.0 / (1.0 + exp(0.0 - mag));
    return from_mag(mag * sig);
}

fn leaky_relu(x: ByteSil, alpha: Float) -> ByteSil {
    let mag = bytesil_magnitude(x);
    if mag > 0.0 {
        return x;
    }
    return from_mag(alpha * mag);
}

fn relu6(x: ByteSil) -> ByteSil {
    let mag = bytesil_magnitude(x);
    let clamped = clamp_float(mag, 0.0, 6.0);
    return from_mag(clamped);
}

fn softmax(s: State) -> State {
    let mv = bytesil_magnitude(state_get_layer(s, 0));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 1)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 2)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 3)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 4)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 5)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 6)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 7)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 8)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 9)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 10)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 11)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 12)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 13)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 14)));
    let mv = max_float(mv, bytesil_magnitude(state_get_layer(s, 15)));
    let e0 = exp(bytesil_magnitude(state_get_layer(s, 0)) - mv);
    let e1 = exp(bytesil_magnitude(state_get_layer(s, 1)) - mv);
    let e2 = exp(bytesil_magnitude(state_get_layer(s, 2)) - mv);
    let e3 = exp(bytesil_magnitude(state_get_layer(s, 3)) - mv);
    let e4 = exp(bytesil_magnitude(state_get_layer(s, 4)) - mv);
    let e5 = exp(bytesil_magnitude(state_get_layer(s, 5)) - mv);
    let e6 = exp(bytesil_magnitude(state_get_layer(s, 6)) - mv);
    let e7 = exp(bytesil_magnitude(state_get_layer(s, 7)) - mv);
    let e8 = exp(bytesil_magnitude(state_get_layer(s, 8)) - mv);
    let e9 = exp(bytesil_magnitude(state_get_layer(s, 9)) - mv);
    let e10 = exp(bytesil_magnitude(state_get_layer(s, 10)) - mv);
    let e11 = exp(bytesil_magnitude(state_get_layer(s, 11)) - mv);
    let e12 = exp(bytesil_magnitude(state_get_layer(s, 12)) - mv);
    let e13 = exp(bytesil_magnitude(state_get_layer(s, 13)) - mv);
    let e14 = exp(bytesil_magnitude(state_get_layer(s, 14)) - mv);
    let e15 = exp(bytesil_magnitude(state_get_layer(s, 15)) - mv);
    let sum_exp = e0 + e1 + e2 + e3 + e4 + e5 + e6 + e7 + e8 + e9 + e10 + e11 + e12 + e13 + e14 + e15;
    let r = state_vacuum();
    let r = state_set_layer(r, 0, from_mag(e0 / sum_exp));
    let r = state_set_layer(r, 1, from_mag(e1 / sum_exp));
    let r = state_set_layer(r, 2, from_mag(e2 / sum_exp));
    let r = state_set_layer(r, 3, from_mag(e3 / sum_exp));
    let r = state_set_layer(r, 4, from_mag(e4 / sum_exp));
    let r = state_set_layer(r, 5, from_mag(e5 / sum_exp));
    let r = state_set_layer(r, 6, from_mag(e6 / sum_exp));
    let r = state_set_layer(r, 7, from_mag(e7 / sum_exp));
    let r = state_set_layer(r, 8, from_mag(e8 / sum_exp));
    let r = state_set_layer(r, 9, from_mag(e9 / sum_exp));
    let r = state_set_layer(r, 10, from_mag(e10 / sum_exp));
    let r = state_set_layer(r, 11, from_mag(e11 / sum_exp));
    let r = state_set_layer(r, 12, from_mag(e12 / sum_exp));
    let r = state_set_layer(r, 13, from_mag(e13 / sum_exp));
    let r = state_set_layer(r, 14, from_mag(e14 / sum_exp));
    let r = state_set_layer(r, 15, from_mag(e15 / sum_exp));
    return r;
}

fn relu_state(s: State) -> State {
    let r = state_vacuum();
    let r = state_set_layer(r, 0, relu(state_get_layer(s, 0)));
    let r = state_set_layer(r, 1, relu(state_get_layer(s, 1)));
    let r = state_set_layer(r, 2, relu(state_get_layer(s, 2)));
    let r = state_set_layer(r, 3, relu(state_get_layer(s, 3)));
    let r = state_set_layer(r, 4, relu(state_get_layer(s, 4)));
    let r = state_set_layer(r, 5, relu(state_get_layer(s, 5)));
    let r = state_set_layer(r, 6, relu(state_get_layer(s, 6)));
    let r = state_set_layer(r, 7, relu(state_get_layer(s, 7)));
    let r = state_set_layer(r, 8, relu(state_get_layer(s, 8)));
    let r = state_set_layer(r, 9, relu(state_get_layer(s, 9)));
    let r = state_set_layer(r, 10, relu(state_get_layer(s, 10)));
    let r = state_set_layer(r, 11, relu(state_get_layer(s, 11)));
    let r = state_set_layer(r, 12, relu(state_get_layer(s, 12)));
    let r = state_set_layer(r, 13, relu(state_get_layer(s, 13)));
    let r = state_set_layer(r, 14, relu(state_get_layer(s, 14)));
    let r = state_set_layer(r, 15, relu(state_get_layer(s, 15)));
    return r;
}

fn sigmoid_state(s: State) -> State {
    let r = state_vacuum();
    let r = state_set_layer(r, 0, sigmoid(state_get_layer(s, 0)));
    let r = state_set_layer(r, 1, sigmoid(state_get_layer(s, 1)));
    let r = state_set_layer(r, 2, sigmoid(state_get_layer(s, 2)));
    let r = state_set_layer(r, 3, sigmoid(state_get_layer(s, 3)));
    let r = state_set_layer(r, 4, sigmoid(state_get_layer(s, 4)));
    let r = state_set_layer(r, 5, sigmoid(state_get_layer(s, 5)));
    let r = state_set_layer(r, 6, sigmoid(state_get_layer(s, 6)));
    let r = state_set_layer(r, 7, sigmoid(state_get_layer(s, 7)));
    let r = state_set_layer(r, 8, sigmoid(state_get_layer(s, 8)));
    let r = state_set_layer(r, 9, sigmoid(state_get_layer(s, 9)));
    let r = state_set_layer(r, 10, sigmoid(state_get_layer(s, 10)));
    let r = state_set_layer(r, 11, sigmoid(state_get_layer(s, 11)));
    let r = state_set_layer(r, 12, sigmoid(state_get_layer(s, 12)));
    let r = state_set_layer(r, 13, sigmoid(state_get_layer(s, 13)));
    let r = state_set_layer(r, 14, sigmoid(state_get_layer(s, 14)));
    let r = state_set_layer(r, 15, sigmoid(state_get_layer(s, 15)));
    return r;
}

fn gelu_state(s: State) -> State {
    let r = state_vacuum();
    let r = state_set_layer(r, 0, gelu(state_get_layer(s, 0)));
    let r = state_set_layer(r, 1, gelu(state_get_layer(s, 1)));
    let r = state_set_layer(r, 2, gelu(state_get_layer(s, 2)));
    let r = state_set_layer(r, 3, gelu(state_get_layer(s, 3)));
    let r = state_set_layer(r, 4, gelu(state_get_layer(s, 4)));
    let r = state_set_layer(r, 5, gelu(state_get_layer(s, 5)));
    let r = state_set_layer(r, 6, gelu(state_get_layer(s, 6)));
    let r = state_set_layer(r, 7, gelu(state_get_layer(s, 7)));
    let r = state_set_layer(r, 8, gelu(state_get_layer(s, 8)));
    let r = state_set_layer(r, 9, gelu(state_get_layer(s, 9)));
    let r = state_set_layer(r, 10, gelu(state_get_layer(s, 10)));
    let r = state_set_layer(r, 11, gelu(state_get_layer(s, 11)));
    let r = state_set_layer(r, 12, gelu(state_get_layer(s, 12)));
    let r = state_set_layer(r, 13, gelu(state_get_layer(s, 13)));
    let r = state_set_layer(r, 14, gelu(state_get_layer(s, 14)));
    let r = state_set_layer(r, 15, gelu(state_get_layer(s, 15)));
    return r;
}

fn swish_state(s: State) -> State {
    let r = state_vacuum();
    let r = state_set_layer(r, 0, swish(state_get_layer(s, 0)));
    let r = state_set_layer(r, 1, swish(state_get_layer(s, 1)));
    let r = state_set_layer(r, 2, swish(state_get_layer(s, 2)));
    let r = state_set_layer(r, 3, swish(state_get_layer(s, 3)));
    let r = state_set_layer(r, 4, swish(state_get_layer(s, 4)));
    let r = state_set_layer(r, 5, swish(state_get_layer(s, 5)));
    let r = state_set_layer(r, 6, swish(state_get_layer(s, 6)));
    let r = state_set_layer(r, 7, swish(state_get_layer(s, 7)));
    let r = state_set_layer(r, 8, swish(state_get_layer(s, 8)));
    let r = state_set_layer(r, 9, swish(state_get_layer(s, 9)));
    let r = state_set_layer(r, 10, swish(state_get_layer(s, 10)));
    let r = state_set_layer(r, 11, swish(state_get_layer(s, 11)));
    let r = state_set_layer(r, 12, swish(state_get_layer(s, 12)));
    let r = state_set_layer(r, 13, swish(state_get_layer(s, 13)));
    let r = state_set_layer(r, 14, swish(state_get_layer(s, 14)));
    let r = state_set_layer(r, 15, swish(state_get_layer(s, 15)));
    return r;
}
